#!/bin/bash
clear
cat << "EOF"                                                            
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⢡⡀⢀⣠⣤⠤⠷⠤⣤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠳⣄⠀⠀⣀⡴⠟⠉⢠⡀⠠⢤⣄⣠⠀⠉⠻⢦⡀⠀⢀⡴⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠄⠀⠀⠈⢳⡞⠉⠀⠀⠀⣠⡇⢀⠄⠀⢷⡀⠀⠀⠀⠘⣶⡋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣰⡟⠉⠒⠦⣄⣠⡏⠀⠀⠀⠀⢰⣿⢀⣴⣶⣦⡄⣻⠄⢀⢀⣠⣤⢧⣄⣠⠤⠒⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣤⣶⣶⣿⡋⠀⠀⠀⠀⠀⡟⠀⠀⢠⣠⠀⠀⠹⣿⣿⣿⣿⣿⠋⠀⠈⡍⠀⠀⠈⣿⠀⠀⠀⠀⠒⢦⠀⠐⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢀⣴⣿⣿⣿⣿⡏⠀⠀⠀⣀⣀⣸⠁⠀⠀⣆⠙⣿⣆⢠⣿⣷⣿⣿⣷⠀⣠⣾⣷⡞⠀⠀⢹⣀⣀⣀⣀⠀⢸⣷⣧⣤⣀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢀⣼⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠸⡄⠀⢀⡘⢦⣿⣿⣿⣿⣿⣿⣿⣿⣶⣿⣿⣩⠇⡀⠀⢸⠀⠀⠀⠀⠉⢸⣿⣿⣿⣮⡁⡀⠀⠀⠀⠀
⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⢄⡀⠀⠀⠀⢀⣷⡸⣄⣙⣷⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣖⡚⠁⢀⣞⡀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⡴⣔⠀⠀⠀
⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠀⠐⠺⡏⣍⣁⠀⣽⣿⣿⣿⣿⣿⣿⣽⣿⣯⣽⣿⣿⣿⣍⢁⡜⠉⠉⠓⢤⣄⣾⣿⣿⣿⣿⣿⣿⣿⣿⣄⠀⠀
⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠠⣷⣿⣗⡤⠈⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠻⠛⢤⡀⠀⠀⣨⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠀
⠀⣿⣿⣿⣿⣿⠿⢿⣿⣿⠿⢿⣿⣿⣿⣿⣷⡀⠈⣿⣿⣄⠀⣿⣿⣿⠁⠹⣿⣿⣿⣿⣿⢿⣿⣗⠀⠀⠀⠉⠂⣠⣿⣿⡿⠿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠀
⢀⡿⡿⠉⣿⡟⠀⢸⣿⠏⠀⠀⢹⠿⠿⢿⣿⣷⣄⠚⢿⣿⣿⣿⡿⠃⢈⣹⣿⣿⣿⣿⣿⡎⢿⣿⣇⠀⠀⣶⣴⣿⣿⣿⣿⣻⣿⣿⣿⣿⣿⣿⣿⣿⣿⡄
⢸⣿⣿⣾⣿⡇⠀⢸⠋⠀⠀⠀⠸⠀⠀⠀⠉⠛⣿⣷⣟⣙⠿⣿⡁⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣾⡿⢿⣿⠟⢿⡏⠀⢸⠉⠁⠀⠈⢹⢿⣿⣿⣿⡇
⢸⣿⣿⣿⣿⡇⠀⠾⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⠍⠛⢿⠷⣶⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢿⣿⣆⠀⠁⠀⠀⠀⠀⠈⠀⠀⠀⠀⠞⠀⠘⣿⣿⣟
⢸⣿⣿⣏⣿⡗⠀⠀⠀⠀⠀⠀⣠⠒⠊⠉⠉⠉⢉⣒⠦⣄⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣤⣿⣿⠿⠶⠶⢤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⡇
⠘⣿⣷⣿⡝⠁⠀⠀⠀⠀⠀⠉⢁⠀⠀⠀⠀⠀⠀⠈⢹⣮⣿⣿⣟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠙⠀⠀⠀⠀⠀⠀⠈⠛⢆⠀⠀⠀⠀⠀⠀⠀⠋⢻⡇
⠀⠻⣿⣤⠁⠀⠀⠀⠀⠀⣤⠈⠋⠀⠀⠀⠀⠀⠀⠀⠈⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠳⡄⠀⠀⠀⠀⠀⢠⡿⠁
⠀⠀⢻⣧⡀⠀⠀⠀⠀⠀⢸⡀⠀⠀⠀⠀⠀⠀⢀⣤⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⡀⠀⠀⠀⠀⣼⠃⠀
⠀⠀⠈⢿⡄⠀⠀⠀⠀⠀⠙⣧⠀⠀⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣧⠀⠀⣀⡼⠁⠀⠀
⠀⠀⠀⠀⠙⢶⡀⠀⠀⠀⠀⢿⣷⠀⠀⢀⣠⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠓⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⠀⠀⠛⠁⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠙⠏⠉⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣿⣿⢿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠁⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⣿⣿⣿⣿⣿⣿⣟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡼⠃⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣟⣷⣀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠞⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣞⣿⣿⣿⣿⣿⣿⣿⣼⣿⣿⣿⡿⣾⢻⣿⣿⡟⢻⣿⣿⣿⣿⣿⣿⠙⠳⢤⣀⣀⣀⣠⡤⠖⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⣿⣿⣿⣿⣿⣿⣿⠇⣿⣿⣿⣿⢳⣿⣿⣿⣿⡇⣾⣿⣿⣿⣿⣿⠹⠄⠀⠀⠀⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣟⣿⣿⣿⣿⣻⣿⣾⣿⣿⢸⣿⣿⣿⣿⡇⣿⣿⣿⢹⣿⣿⣇⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⣅⡿⣫⠟⣿⣿⡿⢹⡿⠿⣿⣿⣧⢸⣿⣿⣿⣿⠇⣿⣿⠇⡞⣿⡏⠉⢷⠴⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡿⠿⠟⠁⠀⡇⢸⡇⢀⣧⡤⢰⣿⡟⢸⡇⡏⢹⣿⠀⣿⡟⠀⢳⣿⡇⠠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠞⠁⠀⠀⡠⠀⠀⠁⣿⠃⢸⣿⠙⢺⣻⡗⠸⡇⠡⢸⣿⣰⠈⠀⠀⢘⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠉⢸⠁⠀⠀⠀⣿⠀⠘⣿⡄⠀⠁⠁⠀⠃⠀⠈⣿⠿⠀⠀⠀⠘⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠙⡇⠀⠀⠀⠀⠀⠀⢀⣏⣥⠀⠀⠀⢠⣤⠔⠀⠦⠤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
███╗   ██╗███████╗██╗   ██╗████████╗███╗   ███╗██╗   ██╗███████╗██╗ ██████╗           
████╗  ██║██╔════╝╚██╗ ██╔╝╚══██╔══╝████╗ ████║██║   ██║██╔════╝██║██╔════╝           
██╔██╗ ██║█████╗   ╚████╔╝    ██║   ██╔████╔██║██║   ██║███████╗██║██║                
██║╚██╗██║██╔══╝    ╚██╔╝     ██║   ██║╚██╔╝██║██║   ██║╚════██║██║██║                
██║ ╚████║███████╗   ██║      ██║   ██║ ╚═╝ ██║╚██████╔╝███████║██║╚██████╗           
╚═╝  ╚═══╝╚══════╝   ╚═╝      ╚═╝   ╚═╝     ╚═╝ ╚═════╝ ╚══════╝╚═╝ ╚═════╝           
                                                                                      
██████╗  ██████╗ ███╗   ██╗██╗    ██╗██╗      ██████╗  █████╗ ██████╗ ███████╗██████╗ 
██╔══██╗██╔═══██╗████╗  ██║██║    ██║██║     ██╔═══██╗██╔══██╗██╔══██╗██╔════╝██╔══██╗
██║  ██║██║   ██║██╔██╗ ██║██║ █╗ ██║██║     ██║   ██║███████║██║  ██║█████╗  ██████╔╝
██║  ██║██║   ██║██║╚██╗██║██║███╗██║██║     ██║   ██║██╔══██║██║  ██║██╔══╝  ██╔══██╗
██████╔╝╚██████╔╝██║ ╚████║╚███╔███╔╝███████╗╚██████╔╝██║  ██║██████╔╝███████╗██║  ██║
╚═════╝  ╚═════╝ ╚═╝  ╚═══╝ ╚══╝╚══╝ ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝ ╚══════╝╚═╝  ╚═╝                                                                                 
EOF
VERSION_LOCAL="1.0.5"
REPO_SCRIPT="https://raw.githubusercontent.com/NeTenebraes/neYTMusic-Downloader/main/neYTMusic.sh"
CHANGELOG_URL="https://raw.githubusercontent.com/NeTenebraes/neYTMusic-Downloader/main/CHANGELOG.md"

UPDATE_CHECK() {
    if ! command -v curl &>/dev/null && ! command -v wget &>/dev/null; then
        echo "curl o wget no encontrados. No se puede comprobar actualizaciones."
        return
    fi
    if ! ping -c 1 github.com &>/dev/null; then
        echo "Sin conexión a internet. Omitiendo comprobación de actualizaciones."
        return
    fi
    if command -v curl &>/dev/null; then
        VERSION_REMOTE=$(curl -fsSL "$REPO_SCRIPT" | grep "^VERSION_LOCAL=" | head -1 | cut -d'"' -f2)
    else
        VERSION_REMOTE=$(wget -qO- "$REPO_SCRIPT" | grep "^VERSION_LOCAL=" | head -1 | cut -d'"' -f2)
    fi
    if [[ "$VERSION_REMOTE" != "$VERSION_LOCAL" && -n "$VERSION_REMOTE" ]]; then
        echo "¡Nueva versión disponible: $VERSION_REMOTE!"
        echo -e "\nCambios recientes:\n"
    if command -v curl &>/dev/null; then
    curl -fsSL "$CHANGELOG_URL" | head -20
        else
    wget -qO- "$CHANGELOG_URL" | head -20
    fi
    echo -e "\n"
        read -e -p "\n\n¿Actualizar ahora el script? [Y/n]: \n" user_update
        if [[ "$user_update" =~ ^[Yy]$ || -z "$user_update" ]]; then
            if command -v curl &>/dev/null; then
                curl -fsSL "$REPO_SCRIPT" -o "$0"
            else
                wget -qO "$0" "$REPO_SCRIPT"
            fi
            chmod +x "$0"
            echo "¡Actualizado! Vuelve a ejecutar el script."
            exit 0
        else
            echo "Continuando con la versión actual ($VERSION_LOCAL)..."
        fi
    else
        echo "Ya tienes la última versión ($VERSION_LOCAL)."
    fi
}

UPDATE_CHECK


CONFIG_DIR="$HOME/.config/neYTMusic"
PROXY_FILE="$CONFIG_DIR/proxy"
LIST_FILE="$CONFIG_DIR/list"
ARCHIVE="$CONFIG_DIR/archive.txt"
PROXY=""
URL=""
DEST="$HOME/Music/YTMusic"

mkdir -p "$CONFIG_DIR"
mkdir -p "$DEST"
cd "$DEST"

# Pregunta principal
read -r -p "¿Quieres descargar música de una Playlist? [Y/n]: " do_dl
case "$do_dl" in
    [Nn]*)
        echo "Saltando descarga. Reproduciendo con mpv en modo aleatorio..."
        shopt -s nullglob
        files=("$DEST"/*.mp3)
        if [ ${#files[@]} -eq 0 ]; then
            echo "No se encontraron archivos mp3 para reproducir. Por favor descarga primero."
            exit 1
        else
            nohup mpv --shuffle "${files[@]}" > /dev/null 2>&1 &
            exit 0
        fi
        ;;
    [Yy]*|"")
        # Selección de la playlist
        if [[ -f "$LIST_FILE" ]]; then
            LAST_URL=$(cat "$LIST_FILE")
            LIST_NAME="$(echo "$LAST_URL" | sed 's|.*list=||;s|&.*||')"
            read -r -p "¿Quieres usar la lista anterior (ID: $LIST_NAME)? [Y/n]: " use_last
            case "$use_last" in
                [Yy]*|"") URL="$LAST_URL";;
                [Nn]*) URL="";;
            esac
        fi

        if [[ -z "$URL" ]]; then
            read -r -p "Pega la URL de la nueva playlist de YouTube Music: " NEW_URL
            if [[ -n "$NEW_URL" ]]; then
                URL="$NEW_URL"
                echo "$URL" > "$LIST_FILE"
            fi
        fi

        if [[ ! "$URL" =~ ^https://music\.youtube\.com/playlist\?list= ]]; then
            echo -e "\nERROR: Solo se admiten playlists de YouTube Music (music.youtube.com)."
            echo "La URL ingresada no corresponde a YouTube Music."
            exit 1
        fi

        # Proxy interactivo
        if [[ -f "$PROXY_FILE" ]]; then
            LAST_PROXY=$(cat "$PROXY_FILE")
            read -r -p "¿Quieres usar el proxy anterior ($LAST_PROXY)? [Y/n]: " use_last_proxy
            case "$use_last_proxy" in
                [Yy]*|"") PROXY="$LAST_PROXY";;
                [Nn]*) PROXY="";;
            esac
        fi

        if [[ -z "$PROXY" ]]; then
            read -r -p "¿Quieres usar un proxy para la descarga? (ejemplo: socks5://127.0.0.1:9050) [Enter para omitir]: " NEW_PROXY
            if [[ -n "$NEW_PROXY" ]]; then
                PROXY="$NEW_PROXY"
                echo "$PROXY" > "$PROXY_FILE"
            fi
        fi

        if [[ -n "$PROXY" ]]; then
            PROXY_ARG="--proxy $PROXY"
        else
            PROXY_ARG=""
        fi

        echo "Descargando solo los temas nuevos en mp3..."
        yt-dlp $PROXY_ARG --yes-playlist -x --audio-format mp3 --embed-thumbnail --embed-metadata --download-archive "$ARCHIVE" "$URL"

        # Reproducir tras descarga
        shopt -s nullglob
        files=("$DEST"/*.mp3)
        if [ ${#files[@]} -eq 0 ]; then
            echo "No se encontraron archivos mp3 después de la descarga."
            exit 1
        else
            echo "¡Listo! Reproduciendo con mpv en modo aleatorio..."
            nohup mpv --shuffle "${files[@]}" > /dev/null 2>&1 &
            exit 0
        fi
        ;;
esac