#!/bin/bash
clear
cat << "EOF"                                                            
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⢡⡀⢀⣠⣤⠤⠷⠤⣤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠳⣄⠀⠀⣀⡴⠟⠉⢠⡀⠠⢤⣄⣠⠀⠉⠻⢦⡀⠀⢀⡴⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠄⠀⠀⠈⢳⡞⠉⠀⠀⠀⣠⡇⢀⠄⠀⢷⡀⠀⠀⠀⠘⣶⡋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣰⡟⠉⠒⠦⣄⣠⡏⠀⠀⠀⠀⢰⣿⢀⣴⣶⣦⡄⣻⠄⢀⢀⣠⣤⢧⣄⣠⠤⠒⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣤⣶⣶⣿⡋⠀⠀⠀⠀⠀⡟⠀⠀⢠⣠⠀⠀⠹⣿⣿⣿⣿⣿⠋⠀⠈⡍⠀⠀⠈⣿⠀⠀⠀⠀⠒⢦⠀⠐⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢀⣴⣿⣿⣿⣿⡏⠀⠀⠀⣀⣀⣸⠁⠀⠀⣆⠙⣿⣆⢠⣿⣷⣿⣿⣷⠀⣠⣾⣷⡞⠀⠀⢹⣀⣀⣀⣀⠀⢸⣷⣧⣤⣀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢀⣼⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠸⡄⠀⢀⡘⢦⣿⣿⣿⣿⣿⣿⣿⣿⣶⣿⣿⣩⠇⡀⠀⢸⠀⠀⠀⠀⠉⢸⣿⣿⣿⣮⡁⡀⠀⠀⠀⠀
⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⢄⡀⠀⠀⠀⢀⣷⡸⣄⣙⣷⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣖⡚⠁⢀⣞⡀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⡴⣔⠀⠀⠀
⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠀⠐⠺⡏⣍⣁⠀⣽⣿⣿⣿⣿⣿⣿⣽⣿⣯⣽⣿⣿⣿⣍⢁⡜⠉⠉⠓⢤⣄⣾⣿⣿⣿⣿⣿⣿⣿⣿⣄⠀⠀
⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠠⣷⣿⣗⡤⠈⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠻⠛⢤⡀⠀⠀⣨⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠀
⠀⣿⣿⣿⣿⣿⠿⢿⣿⣿⠿⢿⣿⣿⣿⣿⣷⡀⠈⣿⣿⣄⠀⣿⣿⣿⠁⠹⣿⣿⣿⣿⣿⢿⣿⣗⠀⠀⠀⠉⠂⣠⣿⣿⡿⠿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠀
⢀⡿⡿⠉⣿⡟⠀⢸⣿⠏⠀⠀⢹⠿⠿⢿⣿⣷⣄⠚⢿⣿⣿⣿⡿⠃⢈⣹⣿⣿⣿⣿⣿⡎⢿⣿⣇⠀⠀⣶⣴⣿⣿⣿⣿⣻⣿⣿⣿⣿⣿⣿⣿⣿⣿⡄
⢸⣿⣿⣾⣿⡇⠀⢸⠋⠀⠀⠀⠸⠀⠀⠀⠉⠛⣿⣷⣟⣙⠿⣿⡁⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣾⡿⢿⣿⠟⢿⡏⠀⢸⠉⠁⠀⠈⢹⢿⣿⣿⣿⡇
⢸⣿⣿⣿⣿⡇⠀⠾⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⠍⠛⢿⠷⣶⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢿⣿⣆⠀⠁⠀⠀⠀⠀⠈⠀⠀⠀⠀⠞⠀⠘⣿⣿⣟
⢸⣿⣿⣏⣿⡗⠀⠀⠀⠀⠀⠀⣠⠒⠊⠉⠉⠉⢉⣒⠦⣄⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣤⣿⣿⠿⠶⠶⢤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⡇
⠘⣿⣷⣿⡝⠁⠀⠀⠀⠀⠀⠉⢁⠀⠀⠀⠀⠀⠀⠈⢹⣮⣿⣿⣟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠙⠀⠀⠀⠀⠀⠀⠈⠛⢆⠀⠀⠀⠀⠀⠀⠀⠋⢻⡇
⠀⠻⣿⣤⠁⠀⠀⠀⠀⠀⣤⠈⠋⠀⠀⠀⠀⠀⠀⠀⠈⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠳⡄⠀⠀⠀⠀⠀⢠⡿⠁
⠀⠀⢻⣧⡀⠀⠀⠀⠀⠀⢸⡀⠀⠀⠀⠀⠀⠀⢀⣤⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⡀⠀⠀⠀⠀⣼⠃⠀
⠀⠀⠈⢿⡄⠀⠀⠀⠀⠀⠙⣧⠀⠀⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣧⠀⠀⣀⡼⠁⠀⠀
⠀⠀⠀⠀⠙⢶⡀⠀⠀⠀⠀⢿⣷⠀⠀⢀⣠⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠓⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⠀⠀⠛⠁⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠙⠏⠉⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣿⣿⢿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠁⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⣿⣿⣿⣿⣿⣿⣟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡼⠃⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣟⣷⣀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠞⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣞⣿⣿⣿⣿⣿⣿⣿⣼⣿⣿⣿⡿⣾⢻⣿⣿⡟⢻⣿⣿⣿⣿⣿⣿⠙⠳⢤⣀⣀⣀⣠⡤⠖⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⣿⣿⣿⣿⣿⣿⣿⠇⣿⣿⣿⣿⢳⣿⣿⣿⣿⡇⣾⣿⣿⣿⣿⣿⠹⠄⠀⠀⠀⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣟⣿⣿⣿⣿⣻⣿⣾⣿⣿⢸⣿⣿⣿⣿⡇⣿⣿⣿⢹⣿⣿⣇⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⣅⡿⣫⠟⣿⣿⡿⢹⡿⠿⣿⣿⣧⢸⣿⣿⣿⣿⠇⣿⣿⠇⡞⣿⡏⠉⢷⠴⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡿⠿⠟⠁⠀⡇⢸⡇⢀⣧⡤⢰⣿⡟⢸⡇⡏⢹⣿⠀⣿⡟⠀⢳⣿⡇⠠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠞⠁⠀⠀⡠⠀⠀⠁⣿⠃⢸⣿⠙⢺⣻⡗⠸⡇⠡⢸⣿⣰⠈⠀⠀⢘⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠉⢸⠁⠀⠀⠀⣿⠀⠘⣿⡄⠀⠁⠁⠀⠃⠀⠈⣿⠿⠀⠀⠀⠘⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠙⡇⠀⠀⠀⠀⠀⠀⢀⣏⣥⠀⠀⠀⢠⣤⠔⠀⠦⠤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
███╗   ██╗███████╗██╗   ██╗████████╗███╗   ███╗██╗   ██╗███████╗██╗ ██████╗           
████╗  ██║██╔════╝╚██╗ ██╔╝╚══██╔══╝████╗ ████║██║   ██║██╔════╝██║██╔════╝           
██╔██╗ ██║█████╗   ╚████╔╝    ██║   ██╔████╔██║██║   ██║███████╗██║██║                
██║╚██╗██║██╔══╝    ╚██╔╝     ██║   ██║╚██╔╝██║██║   ██║╚════██║██║██║                
██║ ╚████║███████╗   ██║      ██║   ██║ ╚═╝ ██║╚██████╔╝███████║██║╚██████╗           
╚═╝  ╚═══╝╚══════╝   ╚═╝      ╚═╝   ╚═╝     ╚═╝ ╚═════╝ ╚══════╝╚═╝ ╚═════╝           
                                                                                      
██████╗  ██████╗ ███╗   ██╗██╗    ██╗██╗      ██████╗  █████╗ ██████╗ ███████╗██████╗ 
██╔══██╗██╔═══██╗████╗  ██║██║    ██║██║     ██╔═══██╗██╔══██╗██╔══██╗██╔════╝██╔══██╗
██║  ██║██║   ██║██╔██╗ ██║██║ █╗ ██║██║     ██║   ██║███████║██║  ██║█████╗  ██████╔╝
██║  ██║██║   ██║██║╚██╗██║██║███╗██║██║     ██║   ██║██╔══██║██║  ██║██╔══╝  ██╔══██╗
██████╔╝╚██████╔╝██║ ╚████║╚███╔███╔╝███████╗╚██████╔╝██║  ██║██████╔╝███████╗██║  ██║
╚═════╝  ╚═════╝ ╚═╝  ╚═══╝ ╚══╝╚══╝ ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝ ╚══════╝╚═╝  ╚═╝                                                                                 
by: NeTenebrae | https://github.com/NeTenebraes
EOF
VERSION_LOCAL="1.0.0"
echo "Versión actual: $VERSION_LOCAL"

REPO_SCRIPT="https://raw.githubusercontent.com/NeTenebraes/neYTMusic-Downloader/main/neYTMusic.sh"
CHANGELOG_URL="https://raw.githubusercontent.com/NeTenebraes/neYTMusic-Downloader/main/CHANGELOG.md"

UPDATE_CHECK() {
    # 1. Verificaciones básicas de conectividad
    if ! ping -c 1 github.com &>/dev/null; then return; fi
    
    # Herramientas necesarias
    if ! command -v sha256sum &>/dev/null; then
        echo "sha256sum no encontrado. No se puede verificar integridad."
        return
    fi

    # 2. Descargar el script remoto
    local remote_content
    if command -v curl &>/dev/null; then
        remote_content=$(curl -fsSL "$REPO_SCRIPT")
    else
        remote_content=$(wget -qO- "$REPO_SCRIPT")
    fi

    if [[ -z "$remote_content" ]]; then return; fi

    # 3. Calcular HASHES
    local current_hash
    current_hash=$(sha256sum "$0" | awk '{print $1}')
    
    local remote_hash
    remote_hash=$(echo "$remote_content" | sha256sum | awk '{print $1}')

    # 4. Comparar
    if [[ "$current_hash" != "$remote_hash" ]]; then
        # Extraer versión remota
        local v_remote=$(echo "$remote_content" | grep "^VERSION_LOCAL=" | head -1 | cut -d'"' -f2)
        
        echo -e "\n¡Cambios Detectados!"
        echo "   Versión del repo: $v_remote"
        #CHANGELOG
            echo -e "\nCHANGELOG:"
    if command -v curl &>/dev/null; then
        curl -fsSL "$CHANGELOG_URL" \
        | grep -vE '^# ' \
        | sed 's/^## //' \
        | head -20
    else
        wget -qO- "$CHANGELOG_URL" \
        | grep -vE '^# ' \
        | sed 's/^## //' \
        | head -20
    fi
        echo -e "\n"
        #Actualización
        read -e -p "Sincronizar última versión del script? [Y/n]: " user_update
        if [[ "$user_update" =~ ^[Yy]$ || -z "$user_update" ]]; then
            echo "$remote_content" > "$0"
            chmod +x "$0"
            echo "¡Sincronizado!"
            exit 0
        else
            echo "Omitiendo sincronización..."
        fi
    fi
}

UPDATE_CHECK

CONFIG_DIR="$HOME/.config/neYTMusic"
PROXY_FILE="$CONFIG_DIR/proxy"
LIST_FILE="$CONFIG_DIR/list"
ARCHIVE="$CONFIG_DIR/archive.txt"
PROXY=""
URL=""
DEST="$HOME/Music/YTMusic"

mkdir -p "$CONFIG_DIR"
mkdir -p "$DEST"
cd "$DEST"

# Pregunta principal
read -r -p "¿Quieres descargar música de una Playlist? [Y/n]: " do_dl
case "$do_dl" in
    [Nn]*)
        echo "Saltando descarga. Reproduciendo con mpv en modo aleatorio..."
        shopt -s nullglob
        files=("$DEST"/*.mp3)
        if [ ${#files[@]} -eq 0 ]; then
            echo "No se encontraron archivos mp3 para reproducir. Por favor descarga primero."
            exit 1
        else
            nohup mpv --shuffle "${files[@]}" > /dev/null 2>&1 &
            exit 0
        fi
        ;;
    [Yy]*|"")
        # Selección de la playlist
        if [[ -f "$LIST_FILE" ]]; then
            LAST_URL=$(cat "$LIST_FILE")
            LIST_NAME="$(echo "$LAST_URL" | sed 's|.*list=||;s|&.*||')"
            read -r -p "¿Quieres usar la lista anterior (ID: $LIST_NAME)? [Y/n]: " use_last
            case "$use_last" in
                [Yy]*|"") URL="$LAST_URL";;
                [Nn]*) URL="";;
            esac
        fi

        if [[ -z "$URL" ]]; then
            read -r -p "Pega la URL de la nueva playlist de YouTube Music: " NEW_URL
            if [[ -n "$NEW_URL" ]]; then
                URL="$NEW_URL"
                echo "$URL" > "$LIST_FILE"
            fi
        fi

        if [[ ! "$URL" =~ ^https://music\.youtube\.com/playlist\?list= ]]; then
            echo -e "\nERROR: Solo se admiten playlists de YouTube Music (music.youtube.com)."
            echo "La URL ingresada no corresponde a YouTube Music."
            exit 1
        fi

        # Proxy interactivo
        if [[ -f "$PROXY_FILE" ]]; then
            LAST_PROXY=$(cat "$PROXY_FILE")
            read -r -p "¿Quieres usar el proxy anterior ($LAST_PROXY)? [Y/n]: " use_last_proxy
            case "$use_last_proxy" in
                [Yy]*|"") PROXY="$LAST_PROXY";;
                [Nn]*) PROXY="";;
            esac
        fi

        if [[ -z "$PROXY" ]]; then
            read -r -p "¿Quieres usar un proxy para la descarga? (ejemplo: socks5://127.0.0.1:9050) [Enter para omitir]: " NEW_PROXY
            if [[ -n "$NEW_PROXY" ]]; then
                PROXY="$NEW_PROXY"
                echo "$PROXY" > "$PROXY_FILE"
            fi
        fi

        if [[ -n "$PROXY" ]]; then
            PROXY_ARG="--proxy $PROXY"
        else
            PROXY_ARG=""
        fi
        #Descarga con yt-dlp
        echo "Descargando solo los temas nuevos en mp3..."
        yt-dlp $PROXY_ARG --yes-playlist -x --audio-format mp3 --embed-thumbnail --embed-metadata --download-archive "$ARCHIVE" "$URL"

        # Reproducir tras descarga
        shopt -s nullglob
        files=("$DEST"/*.mp3)
        if [ ${#files[@]} -eq 0 ]; then
            echo "No se encontraron archivos mp3 después de la descarga."
            exit 1
        else
            echo "¡Listo! Reproduciendo con mpv en modo aleatorio..."
            nohup mpv --shuffle "${files[@]}" > /dev/null 2>&1 &
            exit 0
        fi
        ;;
esac